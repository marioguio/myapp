version: 2
jobs:
  build:
    working_directory: ~/myapp
    docker:
    - image: ruby:2.3.4
    environment:
      - PG_HOST=localhost
      - PG_USER=mario
      - RAILS_ENV=test
      - RACK_ENV=test
      - image: postgres:9.5
      environment:
        - POSTGRES_USER=ubuntu
        - POSTGRES_DB=db_name

        steps:
          - checkout
          - name: Install System Dependencies
          command: apt-get update -qq && apt-get install -y build-essential postgresql libpq-dev nodejs rake
          - name: Install Ruby Dependencies
          command: bundle install
          - name: Set up DB
          command: |
          bundle exec rake db:create db:schema:load --trace
          bundle exec rake db:migrate
          environment:
            DATABASE_URL: "postgres://ubuntu@localhost:5432/db_name"
            # Add the Postgres 9.6 binaries to the path.
            - run: echo ‘/usr/lib/postgresql/9.6/bin/:$PATH’ >> $BASH_ENV
            - run:
              # Add a password to the `ubuntu` user, since Postgres is configured to
              # always ask for a password without sudo, and fails without one.
              command: sudo -u postgres psql -p 5433 -c "create user ubuntu with password ‘ubuntu’;”
              command: sudo -u postgres psql -p 5433 -c "alter user ubuntu with superuser;"

              # Create a new test database.
              command: sudo -u postgres psql -p 5433 -c "create database test;"
